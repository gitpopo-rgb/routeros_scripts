name: Generate RouterOS Scripts

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 02:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'site-list.mjs'
      - 'main.mjs'
      - '.github/workflows/generate-routeros-scripts.yml'

jobs:
  generate:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Clone ios_rule_script Repository
        run: |
          if [ -d "ios_rule_script" ]; then
            echo "Directory ios_rule_script already exists, removing..."
            rm -rf ios_rule_script
          fi
          git clone --depth 1 https://github.com/blackmatrix7/ios_rule_script.git ios_rule_script
          echo "âœ… Successfully cloned ios_rule_script repository"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # cache: 'npm'
      
      - name: Generate RouterOS Scripts
        run: |
          npm run generate
          echo "âœ… RouterOS scripts generated"
      
      - name: Check Generated Files
        run: |
          if [ ! -f "auto_proxy_patch.rsc" ]; then
            echo "âŒ Error: auto_proxy_patch.rsc not found"
            exit 1
          fi
          if [ ! -f "auto_proxy_clean_patch.rsc" ]; then
            echo "âŒ Error: auto_proxy_clean_patch.rsc not found"
            exit 1
          fi
          echo "âœ… Both script files exist"
          echo "ğŸ“Š File sizes:"
          ls -lh auto_proxy_patch.rsc auto_proxy_clean_patch.rsc
      
      - name: Get Current Date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Create Release Tag
        id: create_tag
        run: |
          TAG_NAME="v${{ steps.date.outputs.date }}-$(date +'%H%M%S')"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git tag $TAG_NAME
          git push origin $TAG_NAME
          echo "âœ… Created and pushed tag: $TAG_NAME"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.create_tag.outputs.tag_name }}
          name: RouterOS Scripts - ${{ steps.date.outputs.date }}
          body: |
            ## ğŸ‰ è‡ªåŠ¨ç”Ÿæˆçš„ RouterOS è„šæœ¬
            
            ### ğŸ“¦ æ–‡ä»¶è¯´æ˜
            - `auto_proxy_patch.rsc` - RouterOS ä»£ç†é…ç½®è„šæœ¬ï¼ˆæ·»åŠ è§„åˆ™ï¼‰
            - `auto_proxy_clean_patch.rsc` - RouterOS æ¸…ç†è„šæœ¬ï¼ˆåˆ é™¤è§„åˆ™ï¼‰
            
            ### ğŸ“Š ç”Ÿæˆä¿¡æ¯
            - ç”Ÿæˆæ—¶é—´: ${{ steps.date.outputs.date }}
            - è§¦å‘æ–¹å¼: ${{ github.event_name }}
            - æäº¤: ${{ github.sha }}
            
            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½æ‰€éœ€çš„è„šæœ¬æ–‡ä»¶
            2. åœ¨ RouterOS ä¸­æ‰§è¡Œ `auto_proxy_patch.rsc` æ·»åŠ è§„åˆ™
            3. å¦‚éœ€æ¸…ç†è§„åˆ™ï¼Œæ‰§è¡Œ `auto_proxy_clean_patch.rsc`
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - æ‰§è¡Œå‰è¯·ç¡®ä¿å·²è®¾ç½® `$vpn_dns_server` å˜é‡
            - å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸­éªŒè¯è„šæœ¬
            - æ¸…ç†è„šæœ¬ä¼šåˆ é™¤æ‰€æœ‰ç›¸å…³çš„ DNS é™æ€è®°å½•å’Œåœ°å€åˆ—è¡¨
          files: |
            auto_proxy_patch.rsc
            auto_proxy_clean_patch.rsc
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
